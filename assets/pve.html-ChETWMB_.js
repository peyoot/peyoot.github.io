import{_ as e,o as i,c as a,b as t}from"./app-oTA4_50g.js";const n={},s=t(`<h1 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h1><h2 id="安装前的清理" tabindex="-1"><a class="header-anchor" href="#安装前的清理"><span>安装前的清理</span></a></h2><p>PVE安装盘启动时，选Advance，并进入Rescue Boot, 在开始删除之前，必须先搞清楚当前系统里有什么。以下是关键的检查命令： 检查所有逻辑卷：lvs 检查所有卷组：vgs 检查所有物理卷：pvs 检查ZFS存储池：zpool list 检查Ceph OSD状态：ceph osd tree（如果Ceph服务仍在运行） 查看PVE存储配置：cat /etc/pve/storage.cfg和 pvesm status</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>root@hp850ip67:~# lvs
  LV            VG  Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  data          pve twi-aotz--  &lt;1.67t             17.40  0.79                            
  root          pve -wi-ao----  96.00g                                                    
  swap          pve -wi-ao----   8.00g                                                    
  vm-100-disk-0 pve Vwi-a-tz-- 350.00g data        3.56                                   
  vm-101-disk-0 pve Vwi-a-tz-- 350.00g data        1.10                                   
  vm-102-disk-0 pve Vwi-a-tz-- 350.00g data        80.31                                  
root@hp850ip67:~# vgs
  VG  #PV #LV #SN Attr   VSize  VFree  
  pve   1   6   0 wz--n- &lt;1.82t &lt;16.38g
root@hp850ip67:~# pvs
  PV         VG  Fmt  Attr PSize  PFree  
  /dev/sda3  pve lvm2 a--  &lt;1.82t &lt;16.38g
root@hp850ip67:~# zpool list
no pools available
root@hp850ip67:~# cat /etc/pve/storage.cfg
dir: local
        path /var/lib/vz
        content iso,vztmpl,backup

lvmthin: local-lvm
        thinpool data
        vgname pve
        content rootdir,images
root@hp850ip67:~# pvesm status
Name             Type     Status           Total            Used       Available        %
local             dir     active        98497780         5049764        88398468    5.13%
local-lvm     lvmthin     active      1792008192       311809425      1480198766   17.40%
root@hp850ip67:~# 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、清理Ceph存储（如果存在） 如果您的系统上有Ceph，必须严格按照顺序执行，否则可能导致数据平衡异常甚至集群报错。 首先销毁Ceph存储池（Pool）：在PVE的Web管理界面中，进入“数据中心” -&gt; “Ceph” -&gt; “存储池”，选择要销毁的池并点击“销毁”。系统会要求您手动输入池名称以确认，防止误操作。注意：请不要销毁默认的 device_health_metrics池。您也可以使用命令行工具pvesm来移除Ceph相关的存储定义。 然后逐一下线并销毁OSD：对于每个OSD，先在Web界面（“Ceph” -&gt; “OSD”）中将其设置为“Out”状态，然后“Stop”，最后选择“销毁”。或者使用Ceph命令行工具完成下线操作。 清理Ceph配置文件：完成上述操作后，可以删除Ceph的配置文件目录以彻底清除：rm -rf /etc/pve/ceph.conf /etc/pve/priv/ceph.*（请谨慎操作，此操作不可逆）。</p><p>2、清理ZFS存储池（如果存在） 如果存在ZFS存储池，使用以下命令销毁它（以池名为tank为例）：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>zpool destroy tank
如果池无法正常销毁（例如包含故障设备），可以尝试-f强制销毁

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、清理LVM组件 是最核心的步骤，顺序至关重要，必须从逻辑顶层向物理底层反向删除：逻辑卷(LV) -&gt; 卷组(VG) -&gt; 物理卷(PV)。 删除逻辑卷（LV）：使用lvremove命令。例如，删除卷组pve下的一个逻辑卷data：lvremove /dev/pve/data。系统会提示确认，输入y即可。 删除卷组（VG）：使用vgremove命令。例如，删除名为pve的卷组：vgremove pve。 删除物理卷签名（PV）：使用pvremove命令。此操作会擦除物理设备上的LVM元数据。例如，清除磁盘/dev/sdb上的PV签名：pvremove /dev/sdb。执行后，该磁盘将变为“干净”状态，可重新分区或用于其他用途。</p><h3 id="pve主机版本选择" tabindex="-1"><a class="header-anchor" href="#pve主机版本选择"><span>PVE主机版本选择</span></a></h3><p>pve-meeetingroom-table是验证过的版本，安装的是8.2.2, 应该8.4.1也是稳定版本。</p><p>相关系统信息记录如下: 1.ceph 未安装</p><h3 id="安装时磁盘选项" tabindex="-1"><a class="header-anchor" href="#安装时磁盘选项"><span>安装时磁盘选项</span></a></h3><p>如果只有单盘，并且希望有单盘数据修复能力，只能选择ZFS(raid0)。通过设置 copies=2或更高，在单盘上存储数据副本，实现自我修复。 设置磁盘选项时，取消掉安装U盘，然后2T硬盘设置这些即可： Advanced option: ashift=12, copies=2, compress=lz4, ARC max size = 4096, hdsize=1784</p><p>FQDN设置个好记的，比如pveip67.sho</p><h3 id="安装后的操作" tabindex="-1"><a class="header-anchor" href="#安装后的操作"><span>安装后的操作</span></a></h3><p>1、笔记本合盖不休眠</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>sudo nano /etc/systemd/logind.conf
把HandleLidSwitch相关的两条改为去注释，默认值改为ignore即可
sudo restart systemd-logind 或 reboot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2 、禁用自动每日更新</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>systemctl disable pve-daily-update.timer

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>3、改社区源 商业更新需要订阅，既然用不了，不如就用开源的，当然已经禁用自动每日更新，也没必要经常更新，只是要在源上准备好</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>cd /etc/apt/sources.list.d
备份到~/backup/
ceph的开源(pve 8.4)：deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription
pve的开源社区版本： deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="新建虚拟机设置" tabindex="-1"><a class="header-anchor" href="#新建虚拟机设置"><span>新建虚拟机设置</span></a></h3><p>一般，我们使用portainer，用docker-compose来启用它，然后用portainer管理各种容器。</p><p>为了方便数据盘的备份，可以把/var/lib/docker单独挂载成一个分区，而创建系统时，系统盘就不用很大。 把 /var/lib/docker、/tmp、/home 和 / 作为四个独立分区，新建虚拟机后，先不安装，而是在硬件中编辑添加这些硬盘，以便安装时可以选择挂载。</p><p>分区布局，除新建时的60G系统盘外，添加下面额外盘。如果系统盘被破坏，新创建一个挂载回额外盘即可。</p><p>系统盘60G,作为根文件系统分区，并选择&quot;use as boot device&quot;，这会生成一个1M的BIOS grub spacer分区，然后继续在availabe device里的这个盘添加gpt分区，选择mount为“/”根文件系统。</p><p>/tmp 36G 应对内存和缓存的功能的需求，以解压10G左右的大文件能力所需来规划。</p><p>/var/lib/docker 360G</p><p>/home 200G 充分考虑备份需求，如果启用作为server-maintainer的备份机，每天有1~2G的远程备份增量，在清理机制未充分验证不完善的情况下，保持半年左右的备份能力。</p><p>由于用ZFS，Discard 务必勾选。</p><h3 id="dns相关设置" tabindex="-1"><a class="header-anchor" href="#dns相关设置"><span>DNS相关设置</span></a></h3><p>一般search domain可以用PVE本机型号或本机位置来区别，比如pvehp850gip22.sho，这样就方便用它作为本地域名来操作。DNS用公网的即可。</p><h3 id="zfs相关" tabindex="-1"><a class="header-anchor" href="#zfs相关"><span>ZFS相关</span></a></h3><p>Discard选项要勾选，这个选项允许虚拟机向PVE宿主发送 TRIM/Discard 指令。对于ZFS至关重要：当您在虚拟机内删除文件或格式化时，勾选此选项后，这些操作会通知到底层的ZFS存储。ZFS可以据此回收这些不再使用的数据块空间，避免虚拟磁盘文件（ZVOL）持续膨胀，占用不必要的存储池空间。虚拟机内的操作系统也需要支持并启用TRIM（对于Ubuntu，默认安装的ext4文件系统已支持，无需额外设置）。 另外如果是性能至上，还可以把Cache改为write back，不过只在ZFS池本身需配置了冗余（如RAIDZ1/2，Mirror），这样才能修复断电数据没及时写入的错误。如果是单机raid0就不要动它，用默认即可。</p><h3 id="新安装ubuntu-server精简版后的操作" tabindex="-1"><a class="header-anchor" href="#新安装ubuntu-server精简版后的操作"><span>新安装ubuntu server精简版后的操作</span></a></h3><p>安装一些常用包</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>sudo apt install iputils-ping traceroute tmux nano rsync

docker安装参考其它地方，也包括这些
sudo apt install docker.io docker-compose-v2
sudo apt install docker-buildx

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pve主机启动常见错误解决办法" tabindex="-1"><a class="header-anchor" href="#pve主机启动常见错误解决办法"><span>PVE主机启动常见错误解决办法：</span></a></h3><ul><li>错误类型1：</li></ul><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>TASK ERROR: activating LV &#39;pve/data&#39; failed: Activation of logical volume pve/data is prohibited while logical volume pve/data_tdata is active.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个问题主要是由于LVM的thin provisioning机制在异常关机后出现的元数据同步问题。逻辑卷管理（LVM）的瘦分配扩展，依赖元数据卷(tmeta)和数据卷(tdata)的复杂交互。当系统突然断电或非正常关机时，LVM的thin pool元数据卷（tmeta）和数据卷（tdata）可能处于不一致状态，导致重启时无法正常激活。 解决办法：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>lvchange -an pve/data_tdata
lvchange -an pve/data_tmeta
lvchange -ay pve/data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>另外，采用ZFS能有效避免。ZFS的架构设计完全不同。它采用写时复制（Copy-on-Write）和事务型模型，每次写入都是新的事务，不会覆盖现有数据。这种设计使得ZFS在意外断电后更容易恢复到一致状态，因为它不需要复杂的元数据恢复过程。</p><ul><li>错误类型2：</li></ul><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>/dev/mapper/pve-root contains a file system with errors, check forced.
Inode 5245521 seems to contain garbage.
/dev/mapper/pve-root: UNEXPECTED INCONSISTENCY; RUN fsck Mannually. 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解决办法：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>在(initramfs)提示符下完成：
fsck -y /dev/mapper/pve-root ，
修复完成后，您很可能会看到类似 /dev/mapper/pve-root: FILE SYSTEM WAS MODIFIED​ 或 ***** FILE SYSTEM WAS MODIFIED *****​ 的提示。这表示修复已成功生效。
输入exit命令即可退出 initramfs环境并继续启动系统。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,47),d=[s];function l(r,v){return i(),a("div",null,d)}const c=e(n,[["render",l],["__file","pve.html.vue"]]),o=JSON.parse('{"path":"/zh/note/it/vm/pve.html","title":"安装","lang":"zh-CN","frontmatter":{"description":"安装 安装前的清理 PVE安装盘启动时，选Advance，并进入Rescue Boot, 在开始删除之前，必须先搞清楚当前系统里有什么。以下是关键的检查命令： 检查所有逻辑卷：lvs 检查所有卷组：vgs 检查所有物理卷：pvs 检查ZFS存储池：zpool list 检查Ceph OSD状态：ceph osd tree（如果Ceph服务仍在运行） 查...","head":[["meta",{"property":"og:url","content":"https://peyoot.github.io/zh/note/it/vm/pve.html"}],["meta",{"property":"og:title","content":"安装"}],["meta",{"property":"og:description","content":"安装 安装前的清理 PVE安装盘启动时，选Advance，并进入Rescue Boot, 在开始删除之前，必须先搞清楚当前系统里有什么。以下是关键的检查命令： 检查所有逻辑卷：lvs 检查所有卷组：vgs 检查所有物理卷：pvs 检查ZFS存储池：zpool list 检查Ceph OSD状态：ceph osd tree（如果Ceph服务仍在运行） 查..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"安装\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[]}"]]},"headers":[{"level":2,"title":"安装前的清理","slug":"安装前的清理","link":"#安装前的清理","children":[{"level":3,"title":"PVE主机版本选择","slug":"pve主机版本选择","link":"#pve主机版本选择","children":[]},{"level":3,"title":"安装时磁盘选项","slug":"安装时磁盘选项","link":"#安装时磁盘选项","children":[]},{"level":3,"title":"安装后的操作","slug":"安装后的操作","link":"#安装后的操作","children":[]},{"level":3,"title":"新建虚拟机设置","slug":"新建虚拟机设置","link":"#新建虚拟机设置","children":[]},{"level":3,"title":"DNS相关设置","slug":"dns相关设置","link":"#dns相关设置","children":[]},{"level":3,"title":"ZFS相关","slug":"zfs相关","link":"#zfs相关","children":[]},{"level":3,"title":"新安装ubuntu server精简版后的操作","slug":"新安装ubuntu-server精简版后的操作","link":"#新安装ubuntu-server精简版后的操作","children":[]},{"level":3,"title":"PVE主机启动常见错误解决办法：","slug":"pve主机启动常见错误解决办法","link":"#pve主机启动常见错误解决办法","children":[]}]}],"git":{},"autoDesc":true,"filePathRelative":"zh/note/it/vm/pve.md"}');export{c as comp,o as data};
