import{_ as e,o as r,c as t,b as o}from"./app-oTA4_50g.js";const a={},i=o(`<h1 id="portainer和docker容器的备份与恢复" tabindex="-1"><a class="header-anchor" href="#portainer和docker容器的备份与恢复"><span>Portainer和docker容器的备份与恢复</span></a></h1><p>当前采用的服务器管理策略是，使用docker-compose来运行portainer，然后使用portainer来管理docker容器，主要用stack的方式来编排服务，包括dnmp,trilium等。</p><p>服务器采用server-maintainer这一自研的运维管理脚本，每天一个备份，包括docker volumn，以及其相应的压缩包异地rsync同步备份，另有网站的打包备份等。</p><p>恢复时的策略包括：docker volume的备份档恢复和在其它机器中用压缩包恢复。</p><h2 id="docker-volume整盘恢复" tabindex="-1"><a class="header-anchor" href="#docker-volume整盘恢复"><span>docker volume整盘恢复</span></a></h2><p>由于portainer的管理数据也在docker volume中，所以整盘恢复理论上不需要任何操作就可以直接运行，只要目标机器上有docker和docker compose即可。</p><p>在PVE中，我们把/var/lib/docker作为一个独立的磁盘分区挂载，虚拟机安装完后，先安装docker:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>sudo apt install iputils-ping traceroute tmux nano rsync
sudo apt install docker.io docker-compose-v2
sudo apt install docker-buildx
sudo usermod -aG docker $USER
newgrp docker
创建pvpn网络
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果我们从未运行任何容器，/var/lib/docker/volume这一目录是空的，如果已经有运行过程序，也可以清空。 使用server-maintainer，一般在远程机上，docker卷的路径在~/remote-bk/ecceeweb1/server-maintainer/backups/docker_volumes下的volumes目录，只需将这个docker的volume目录同步到/var/lib/docker/volume，相关的服务即可恢复 不同docker版本是否会有影响，一般还是要看release note，小的变更如27.5到28.2应该是兼容的。但如果docker compose有大变化，则由它编排的portainer容器也容易出问题，更重要的是portainer的版本最好是相同的。如果这个卷没压缩备份档，请先压缩一下，然后就可以删除docker compose创建的portainer相关的东西。</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>cd
cd remote-bk/ecceeweb1/server-maintainer/backups/docker_volumes/volumes/
rm -rf backingFsBlockDev metadata.db portainer_data/
sudo -H tmux
cp -r volumes /var/lib/docker/
reboot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>~/docker/portainer
dockmer compose up -d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>打开http://10.70.1.90:9000 ,从备份的portainer-backup_日期.tar.gz.encrypted恢复，然后输入portainer密码。 可能要先把编排的服务停止一下，再开始，就可以用了。</p>`,13),n=[i];function d(c,s){return r(),t("div",null,n)}const p=e(a,[["render",d],["__file","portainer.html.vue"]]),m=JSON.parse('{"path":"/zh/note/it/vm/portainer.html","title":"Portainer和docker容器的备份与恢复","lang":"zh-CN","frontmatter":{"description":"Portainer和docker容器的备份与恢复 当前采用的服务器管理策略是，使用docker-compose来运行portainer，然后使用portainer来管理docker容器，主要用stack的方式来编排服务，包括dnmp,trilium等。 服务器采用server-maintainer这一自研的运维管理脚本，每天一个备份，包括docker ...","head":[["meta",{"property":"og:url","content":"https://peyoot.github.io/zh/note/it/vm/portainer.html"}],["meta",{"property":"og:title","content":"Portainer和docker容器的备份与恢复"}],["meta",{"property":"og:description","content":"Portainer和docker容器的备份与恢复 当前采用的服务器管理策略是，使用docker-compose来运行portainer，然后使用portainer来管理docker容器，主要用stack的方式来编排服务，包括dnmp,trilium等。 服务器采用server-maintainer这一自研的运维管理脚本，每天一个备份，包括docker ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Portainer和docker容器的备份与恢复\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[]}"]]},"headers":[{"level":2,"title":"docker volume整盘恢复","slug":"docker-volume整盘恢复","link":"#docker-volume整盘恢复","children":[]}],"git":{},"autoDesc":true,"filePathRelative":"zh/note/it/vm/portainer.md"}');export{p as comp,m as data};
